<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\Customer\CreateAccountButton;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\ReCaptcha;
use Magento\Customer\Block\Form\Register;
use Magento\Framework\Escaper;

/** @var Register $block */
/** @var Escaper $escaper */
/** @var ReCaptcha $recaptcha */
/** @var CreateAccountButton $createAccountButtonViewModel */
/** @var ViewModelRegistry $viewModels */
/** @var HeroiconsSolid $heroicons */

$formId = 'account-create-form';
$recaptcha = $block->getData('viewModelRecaptcha');
$heroicons = $viewModels->require(HeroiconsSolid::class);
$createAccountButtonViewModel = $viewModels->require(CreateAccountButton::class);
$minimumPasswordLength = $block->getMinimumPasswordLength();
$passwordMinCharacterSets = $block->getRequiredCharacterClassesNumber();
$isAutocompleteEnabled = $block->getConfig('customer/password/autocomplete_on_storefront');
?>

<div class="container mx-auto flex h-full items-center px-5">
    <div class="mx-auto mb-16 w-[412px] max-w-full">
        <header class="flex items-center justify-between sm:text-center">
            <h2 class="mb-7 w-full text-2xl" tabindex="-1"><?= __('Create account') ?></h2>
        </header>
        <div class="flex items-center">
            <div class="w-full">
                <form id="<?= $escaper->escapeHtmlAttr($formId) ?>"
                      action="<?= $escaper->escapeUrl($block->getPostActionUrl()) ?>" method="post"
                      novalidate="novalidate" enctype="multipart/form-data" autocomplete="off"
                      x-data="Object.assign(hyva.formValidation($el), initForm())"
                      @submit.prevent="submitForm">
                    <?= $block->getBlockHtml('formkey'); ?>
                    <?= $block->getChildHtml('form_fields_before') ?>
                    <?= $recaptcha ? $recaptcha->getInputHtml(ReCaptcha::RECAPTCHA_FORM_ID_CUSTOMER_CREATE) : '' ?>

                    <div class="mt-3 flex flex-col">
                        <label for="first_name" class="sr-only tracking-widest">
                            <?= __('First name') ?>
                        </label>
                        <input
                            type="text"
                            name="firstname"
                            id="first_name"
                            placeholder="<?= __('First name') ?>"
                            class="input__field input__field--outline bg-bg-500 px-5 py-4"
                            value="<?= $escaper->escapeHtmlAttr($block->getFormData()->getFirstname()) ?>"
                            autocomplete="given-name"
                        />
                    </div>

                    <div class="mt-3 flex flex-col">
                        <label for="last_name" class="sr-only tracking-widest">
                            <?= __('Last name') ?>
                        </label>
                        <input
                            type="text"
                            name="lastname"
                            id="last_name"
                            placeholder="<?= __('Last name') ?>"
                            class="input__field input__field--outline bg-bg-500 px-5 py-4"
                            value="<?= $escaper->escapeHtmlAttr($block->getFormData()->getLastname()) ?>"
                            autocomplete="family-name"
                        />
                    </div>

                    <div class="mt-3 flex flex-col">
                        <label for="email_address" class="sr-only tracking-widest">
                            <?= __('Email') ?>
                        </label>
                        <input
                            type="email"
                            name="email"
                            id="email_address"
                            placeholder="<?= __('Email') ?>"
                            class="input__field input__field--outline bg-bg-500 px-5 py-4"
                            value="<?= $escaper->escapeHtmlAttr($block->getFormData()->getEmail()) ?>"
                            autocomplete="email"
                            required
                        />
                    </div>

                    <div class="mt-3 flex flex-col">
                        <label for="password" class="sr-only tracking-widest">
                            <?= __('Password') ?>
                        </label>
                        <input
                            type="password"
                            name="password"
                            id="password"
                            placeholder="<?= __('Password') ?>"
                            class="input__field input__field--outline bg-bg-500 px-5 py-4"
                            required
                            data-validate='{"password-strength": {"minCharacterSets": <?= (int)$passwordMinCharacterSets ?>}}'
                            autocomplete="<?= $isAutocompleteEnabled ? 'new-password' : 'off' ?>"
                        />
                    </div>

                    <button class="button button--filled-primary mt-7 w-full py-4">
                        <?= __('Create') ?>
                    </button>

                    <div class="mt-6 text-center text-sm tracking-wider">
                        <a href="<?= $escaper->escapeUrl($block->getBackUrl()) ?>"
                           class="link link--primary text-md">
                            <?= __('Back to login') ?>
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function initForm() {
        return {
            errors: 0,
            submitForm() {
                this.validate()
                    .then(() => {
                        // Do not rename $form, the variable is expected to be declared in the recaptcha output
                        const $form = document.querySelector('#<?= $escaper->escapeJs($formId) ?>');
                        <?= $recaptcha ? $recaptcha->getValidationJsHtml(ReCaptcha::RECAPTCHA_FORM_ID_CUSTOMER_CREATE) : '' ?>

                        if (this.errors === 0) {
                            $form.submit();
                        }
                    })
                    .catch((invalid) => {
                        if (invalid.length > 0) {
                            invalid[0].focus();
                        }
                    });
            },
        };
    }
</script>
