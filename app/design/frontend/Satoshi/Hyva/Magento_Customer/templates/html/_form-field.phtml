<?php

declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var Escaper $escaper */

$fieldType = $escaper->escapeHtmlAttr($block->getData('type')) ?? 'text';
$fieldName = $escaper->escapeHtmlAttr($block->getData('name') ?? 'input_name');
$fieldId = $escaper->escapeHtmlAttr($block->getData('id') ?? $fieldName);
$fieldLabel = $escaper->escapeHtml($block->getData('label') ?? ucfirst($fieldName));
$fieldValue = $escaper->escapeHtmlAttr($block->getData('value') ?? '');
$placeholder = $escaper->escapeHtmlAttr($block->getData('placeholder') ?? $fieldLabel);
$additionalClasses = 'input__field input__field--outline h-auto px-5 py-4 ' . $escaper->escapeHtmlAttr($block->getData('class') ?? '');
$additionalAttributes = $block->getData('attributes') ?? '';
$shouldRenderContainer = (bool)$block->getData('render_container') ?? true;

$options = $block->getData('options') ?? [];
$defaultOption = $block->getData('default_option') ?? '';
$isAssociativeOptions = array_keys($options) !== range(0, count($options) - 1);
$alpineDataSource = $block->getData('alpine_data_source') ?? '';
$optionValueField = $block->getData('option_value_field') ?? 'id';
$optionLabelField = $block->getData('option_label_field') ?? 'name';

$attributes = [
    'type' => $fieldType,
    'name' => $fieldName,
    'id' => $fieldId,
    'placeholder' => $placeholder,
    'value' => $fieldValue,
    'class' => $additionalClasses,
];

if ($fieldType !== 'select') {
    $attributes['value'] = $fieldValue;
}

$attributesString = '';
foreach ($attributes as $attrKey => $attrValue) {
    if ($attrValue !== '') {
        $attributesString .= sprintf(' %s="%s"', $attrKey, $attrValue);
    }
}

$attributesString = trim($attributesString . ' ' . $additionalAttributes);

?>

<?php if ($shouldRenderContainer): ?>
<div class="w-full">
    <?php endif; ?>

    <?php if ($fieldType !== 'checkbox'): ?>
        <label class="sr-only tracking-widest" for="<?= $fieldId ?>">
            <span><?= $escaper->escapeHtml($fieldLabel) ?></span>
        </label>
    <?php endif; ?>

    <div>
        <?php if ($fieldType === 'select' && !empty($options)): ?>
            <select <?= $attributesString ?>>
                <?php if (!empty($defaultOption)): ?>
                    <option value=""><?= $escaper->escapeHtml($defaultOption) ?></option>
                <?php endif; ?>
                <?php foreach ($options as $key => $option): ?>
                    <option
                        value="<?= $escaper->escapeHtmlAttr($isAssociativeOptions ? $key : $option) ?>"
                        <?= ($isAssociativeOptions ? $key : $option) == $fieldValue ? 'selected' : '' ?>>
                        <?= $escaper->escapeHtml(__($option)) ?>
                    </option>
                <?php endforeach; ?>
            </select>
        <?php elseif ($fieldType === 'select' && $alpineDataSource): ?>
            <!-- Support for dynamic options using x-for with data source -->
            <select <?= $attributesString ?>>
                <?php if (!empty($defaultOption)): ?>
                    <option value=""><?= $escaper->escapeHtml($defaultOption) ?></option>
                <?php endif; ?>
                <template x-for="(item) in <?= $alpineDataSource ?>" :key="item['<?= $optionValueField ?>']">
                    <option :value="item['<?= $optionValueField ?>']"
                            x-text="item['<?= $optionLabelField ?>']"
                            :selected="item['<?= $optionValueField ?>'] === '<?= $fieldValue ?>'"></option>
                </template>
            </select>
        <?php else: ?>
            <input <?= $attributesString ?> />
        <?php endif; ?>
    </div>

    <?php if ($fieldType === 'checkbox'): ?>
        <label for="<?= $fieldId ?>">
            <span><?= $escaper->escapeHtml($fieldLabel) ?></span>
        </label>
    <?php endif; ?>

    <?php if ($shouldRenderContainer): ?>
</div>
<?php endif; ?>
