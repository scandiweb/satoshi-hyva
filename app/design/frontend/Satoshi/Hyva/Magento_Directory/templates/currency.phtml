<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Satoshi\Theme\ViewModel\Currency;
use Magento\Framework\Escaper;
use Satoshi\Theme\Block\Template;

/** @var Template $template */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var Currency $currencyViewModel */
$currencyViewModel = $viewModels->require(Currency::class);
$currencies = $currencyViewModel->getCurrencies();
$currentCurrencyCode = $currencyViewModel->getCurrentCurrencyCode();

$options = [];
foreach ($currencies as $code => $currency) {
    $name = __($currency['name']);
    $symbol = $currency['symbol'] ? "({$currency['symbol']})" : '';
    $label = "
        <span>{$escaper->escapeHtml($name)}</span>
        <span>{$escaper->escapeHtml("$code $symbol")}</span>
    ";

    $postData = json_decode($currencyViewModel->getSwitchCurrencyPostData($code), true);
    $url = "{$postData['action']}?currency={$postData['data']['currency']}&uenc={$postData['data']['uenc']}";
    $switchUrl = "fetchAndReplaceContent('{$escaper->escapeUrl($url)}')";
    $isCurrent = $code === $currentCurrencyCode;

    $options[] = [
        'value' => $escaper->escapeHtml($code),
        'label' => $label,
        // Clear all cached GraphQL search queries before executing the currency switch.
        // This ensures that outdated search results are not displayed after switching currencies.
        'on_click' => $isCurrent ? "'return false;'" : "
            caches.open('graphql').then(function(cache) {
                cache.keys().then(function(keys) {
                    keys.forEach(function(request) {
                        if (request.url.includes('/graphql?query=')) {
                            cache.delete(request);
                        }
                    });
                });
            });
            {$escaper->escapeHtml($switchUrl)}",
        'is_active' => $isCurrent,
    ];
}

$currency = $currencies[$currentCurrencyCode];
if ($currency) {
    $currentSymbol = !empty($currency['symbol']) ? " ({$currency['symbol']})" : '';
    $currentLabel = __($currency['name']) . " | {$currentCurrencyCode}{$currentSymbol}";
} else {
    $currentLabel = $currentCurrencyCode;
}
?>

<?php if ($currencyViewModel->getCurrencyCount() > 1): ?>
    <?=
    $template
        ->setData([
            'id' => 'currency-selector',
            'label' => $escaper->escapeHtml($currentLabel),
            'options' => $options,
            'withSearch' => true,
            'placement' => 'top',
        ])
        ->render('Magento_Theme::html/components/dropdown.phtml');
    ?>
<?php endif; ?>
