<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\StoreConfig;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Catalog\Block\Product\View\Gallery;
use Magento\Catalog\Helper\Image;
use Magento\Framework\Escaper;

/** @var Escaper $escaper */
/** @var Gallery $block */
/** @var ViewModelRegistry $viewModels */

/** @var StoreConfig $storeConfig */
$storeConfig = $viewModels->require(StoreConfig::class);

/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

$images = $block->getGalleryImages()->getItems();
$mainImage = current(array_filter($images, [$block, 'isMainImage']));

if (!empty($images) && empty($mainImage)) {
    $mainImage = reset($images);
}

/** @var Image $helper */
$helper = $block->getData('imageHelper');
$mainImageUrl = $mainImage ?
    $mainImage->getData('medium_image_url') :
    $helper->getDefaultPlaceholderUrl('image');


$isContain = false;
$mixBackground = true;
$productName = $block->getProduct()->getName();
?>

<div class="flex w-full flex-col gap-4 md:grid md:grid-cols-[repeat(auto-fit,1fr)] md:gap-5 md:pb-7 lg:grid-cols-[repeat(auto-fit,minmax(300px,1fr))] max-md:-mt-8">
    <!-- Main image with anti blinking -->
    <div class="relative flex aspect-product flex-shrink-0 items-center justify-center overflow-hidden bg-[--fade-in-bg] md:rounded-2xl max-md:hidden">
        <div
            x-data="
                TransitionImage({
                    src: '<?= $mainImageUrl ?>',
                    imageId: '<?= $mainImage ? 'main-image-' . $mainImage->getData('position') : 'main-image' ?>'
                })
            "
            x-show="!!src"
            class="<?= $isContain ? 'p-[4%]' : 'size-full' ?> hide-unless-transition absolute inset-0 z-10 flex items-center justify-center bg-[--fade-in-bg] transition-opacity delay-1000 duration-300"
            :class="{ 'opacity-0': isImgLoaded }"
        >
            <img
                height="100%"
                width="100%"
                class="object-center <?= $isContain ? 'object-contain rounded-2xl max-h-full w-auto' : 'object-cover size-full' ?> <?= $mixBackground ? 'mix-blend-darken' : '' ?>"
                :src="src"
                alt="<?= $mainImage ? $escaper->escapeHtmlAttr($mainImage->getData('label')) : '' ?>"
            >
        </div>

        <div class="flex items-center justify-center size-full bg-[--fade-in-bg] <?= $isContain ? 'p-[4%]' : '' ?>">
            <img
                class="object-center no-fade <?= $mixBackground ? 'mix-blend-darken' : '' ?> <?= $isContain ? 'object-contain rounded-2xl max-h-full w-auto' : 'object-cover size-full' ?>"
                src="<?= $mainImageUrl ?>"
                alt="<?= $mainImage ? $escaper->escapeHtmlAttr($mainImage->getData('label')) : '' ?>"
                id="<?= $mainImage ? 'main-image-' . $mainImage->getData('position') : 'main-image' ?>"
            >
            <?php if($mainImage && $mainImage->getData('media_type') && str_contains($mainImage->getData('media_type'), 'video')): ?>
                <template x-if="!$store.main.isMobile">
                    <div class="contents">
                        <!-- Play button -->
                        <button
                            type="button"
                            class="group absolute inset-0 grid place-items-center"
                            aria-label="<?= $escaper->escapeHtmlAttr(__('Play video')) ?>"
                            @click="activateVideo(<?= $mainImage->getData('position') ?>)"
                            @keydown.enter="activateVideo(<?= $mainImage->getData('position') ?>)"
                            x-cloak
                        >
                            <?= $heroiconsSolid->playHtml(
                                'stroke-white/75 fill-black/20 transition ease-in group-hover:scale-110 md:w-24 md:h-24',
                                44,
                                44,
                                ['aria-hidden' => 'true']
                            ); ?>
                        </button>

                        <!-- Youtube container -->
                        <div class="absolute inset-0 hidden size-full bg-bg-400"
                            :class="{ 'hidden': activeVideoType !== 'youtube' }"
                            x-transition.opacity.duration.500ms
                            x-show="activeVideoType === 'youtube'"
                        >
                            <div id="youtube-player-<?= $mainImage->getData('position') ?>" class="size-full"></div>
                        </div>

                        <!-- Video container -->
                        <div class="absolute inset-0 hidden size-full bg-bg-400"
                            :class="{ 'hidden': activeVideoType !== 'vimeo' }"
                            x-transition.opacity.duration.500ms
                            x-show="activeVideoType === 'vimeo'"
                        >
                            <div id="vimeo-player-<?= $mainImage->getData('position') ?>" class="size-full"></div>
                        </div>
                    </div>
                </template>
            <?php endif; ?>
        </div>
    </div>

    <!-- Other images  -->
    <template x-for="(image, index) in images.filter(img => img.img !== '<?= $mainImageUrl ?>')" :key="index">
        <div class="animate-on-transition relative aspect-product flex-shrink-0 overflow-hidden border-black md:rounded-2xl">
            <div class="flex items-center justify-center size-full bg-[--fade-in-bg] <?= $isContain ? 'p-[4%]' : '' ?>">
                <img
                    :alt="image.caption || '<?= $escaper->escapeJs($productName) ?>'"
                    :title="image.caption || '<?= $escaper->escapeJs($productName) ?>'"
                    class="object-center <?= $mixBackground ? 'mix-blend-darken' : '' ?> <?= $isContain ? 'object-contain rounded-2xl max-h-full w-auto' : 'object-cover size-full' ?>"
                    :src="image.img"
                />

                <!-- Play button -->
                <button
                    x-show="image.type === 'video'"
                    type="button"
                    class="group absolute inset-0 grid place-items-center"
                    aria-label="<?= $escaper->escapeHtmlAttr(__('Play video')) ?>"
                    @click="activateVideo(image.position)"
                    @keydown.enter="activateVideo(image.position)"
                    x-cloak
                >
                    <?= $heroiconsSolid->playHtml(
                        'stroke-white/75 fill-black/20 transition ease-in group-hover:scale-110 md:w-24 md:h-24',
                        44,
                        44,
                        ['aria-hidden' => 'true']
                    ); ?>
                </button>

                <!-- Youtube container -->
                <div class="absolute inset-0 hidden size-full bg-bg-400"
                    :class="{ 'hidden': activeVideoType !== 'youtube' }"
                    x-transition.opacity.duration.500ms
                    x-show="image.type === 'video' && activeVideoType === 'youtube'"
                >
                    <div :id="`youtube-player-${image.position}`" class="size-full"></div>
                </div>

                <!-- Video container -->
                <div class="absolute inset-0 hidden size-full bg-bg-400"
                    :class="{ 'hidden': activeVideoType !== 'vimeo' }"
                    x-transition.opacity.duration.500ms
                    x-show="image.type === 'video' && activeVideoType === 'vimeo'"
                >
                    <div :id="`vimeo-player-${image.position}`" class="size-full"></div>
                </div>
            </div>
        </div>
    </template>

    <?php if (count($images) > 2): // To eliminate images shifting when javascript loads ?>
        <div :class="'hidden'"></div>
        <div :class="'hidden'"></div>
    <?php elseif (count($images) > 1): ?>
        <div :class="'hidden'"></div>
    <?php endif; ?>
</div>
