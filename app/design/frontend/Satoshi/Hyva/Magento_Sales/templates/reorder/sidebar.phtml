<?php

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\Customer;
use Magento\Framework\Escaper;
use Magento\Sales\Block\Reorder\Sidebar;
use Hyva\Theme\ViewModel\SvgIcons;

/** @var Escaper $escaper */
/** @var Sidebar $block */
/** @var ViewModelRegistry $viewModels  */
/** @var Customer $customer */
/** @var SvgIcons $hyvaicons */
$hyvaicons = $viewModels->require(SvgIcons::class);

$customer = $viewModels->require(Customer::class);

if (! $customer->customerLoggedIn()) {
    return '';
}

?>

<div x-data="RecentOrders"
    @private-content-loaded.window="receiveReorderData($event.detail.data)"
    class="hidden mb-7"
    :class="{ 'hidden': !itemCount }"
    :aria-hidden="!itemCount"
>
    <div class="bg-bg-400 rounded-md mt-5">
        <h2 class="text-text-500 text-lg font-bold p-4" id="block-reorder-heading">
            <?= $escaper->escapeHtml(__('Recently Ordered')) ?>
        </h2>
        <div class="p-4 border-t border-bg-600">
            <form method="post"
                action="<?= $escaper->escapeUrl($block->getFormActionUrl()) ?>"
                id="reorder-validate-detail"
                aria-labelledby="block-reorder-heading"
            >
                <template x-if="itemCount">
                    <div>
                        <ol id="cart-sidebar-reorder" class="px-4 flex flex-col gap-3">
                            <template x-for="product in reorderItems">
                                <li>
                                    <label class="flex items-center gap-3" :for="checkboxId + product.id">
                                        <input
                                        type="checkbox"
                                        name="order_items[]"
                                        :id="checkboxId + product.id"
                                        :value="product.id"
                                        :aria-label="product.is_saleable
                                            ? hyva.str('<?= $escaper->escapeJs(__('Select product "%1" to reorder')) ?>', product.name)
                                            : hyva.str('<?= $escaper->escapeJs(__('Product "%1" is not salable')) ?>', product.name)
                                        "
                                        :disabled="!product.is_saleable"
                                        class="checkbox__input"
                                        >
                                            <span class="checkbox__control" aria-hidden="true">
                                                <?= $hyvaicons->renderHtml('checkmark') ?>
                                            </span>
                                            <a
                                                class="checkbox__label ml-0"
                                                :href="product.url"
                                                :title="product.name"
                                                :aria-describedby="!product.is_saleable || checkboxId + product.id"
                                                x-text="product.name"
                                            ></a>
                                    </label>
                                </li>
                            </template>
                        </ol>

                        <div id="cart-sidebar-reorder-advice-container"></div>
                    </div>
                </template>
            </form>
        </div>
    </div>

    <div class="mt-5">
        <template x-if="isShowAddToCart">
            <button
                type="button"
                @click.prevent="addToCart('<?= $escaper->escapeUrl($block->getFormActionUrl()) ?>')"
                class="button button--filled-primary max-md:w-full"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Add to cart selected products from list')) ?>"
                data-addto="cart"
            >
                <?= $escaper->escapeHtml(__('Add to Cart')) ?>
            </button>
        </template>
        <a href="<?= $escaper->escapeUrl($block->getUrl('customer/account')) ?>#recentOrders"
            class="button button--ghost-primary max-md:w-full max-md:mt-4"
            aria-label="<?= $escaper->escapeHtmlAttr(__('View all recent orders')) ?>"
        >
            <?= $escaper->escapeHtml(__('View All')); ?>
        </a>
    </div>
</div>