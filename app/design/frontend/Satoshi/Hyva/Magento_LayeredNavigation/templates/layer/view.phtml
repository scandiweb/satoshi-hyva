<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Magento\LayeredNavigation\Block\Navigation;
use Hyva\Theme\ViewModel\SvgIcons;
use Satoshi\Theme\Block\Popup;

/** @var Popup $popup */
/** @var Navigation $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */


/** @var SvgIcons $hyvaicons */
$hyvaicons = $viewModels->require(SvgIcons::class);

$filters = $block->getFilters();

$filteredFilters = array_filter($filters, function ($filter) {
    return $filter->getItemsCount();
});
?>
<?php if ($block->canShowBlock()): ?>
    <div id="filters-sidebar" class="relative" x-data="Filters">
        <div class="absolute right-0 top-[-68px] ml-8 md:pl-2">
            <button
                type="button"
                class="button button--filled-primary hidden w-[275px] min-w-[275px] md:inline-flex"
                @click="$store.productList.toggleFiltersSidebar()"
            >
                <span
                    x-text="$store.productList.isFiltersSidebarExpanded ? '<?= __('Hide filter') ?>' : '<?= __('Show filter') ?>'"
                >
                    <?= __('Hide filter') ?>
                </span>
                <span class="button__icon ml-3 text-xl">
                    <?= $hyvaicons->renderHtml('filter'); ?>
                </span>
            </button>
        </div>

        <template x-portal="document.getElementById($store.main.isMobile ? 'toolbar-filters' : 'filters-sidebar')">
            <div
                role="region"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Available filters')) ?>"
                class="overflow-x-scroll max-md:pb-4 max-md:pt-2 md:overflow-hidden"
                x-cloak
            >
                <div class="translate-x-0 transition-transform motion-reduce:transition-none" :class="($store.productList.isFiltersSidebarExpanded || $store.main.isMobile) ? 'translate-x-0' : 'translate-x-full'">
                    <div class="max-md:flex max-md:w-max max-md:gap-3 transition-transform duration-300">
                        <?= $block->getChildHtml('state') ?>

                        <?php foreach ($filteredFilters as $filter): ?>
                            <fieldset class="md:flex-1 md:border-t md:border-bg-600 md:py-5" x-data="Accordion(true, 300)">
                                <template x-if="!$store.main.isMobile">
                                    <div class="contents">
                                        <div
                                            class="group hidden h-11 w-full cursor-pointer items-center rounded-md py-3 md:flex md:px-2"
                                            x-ref="AccordionButton"
                                        >
                                            <h2 class="grow text-left text-text-500">
                                                <?= $escaper->escapeHtml(__($filter->getName())) ?>
                                            </h2>
                                            <button
                                                class="button button--outline-secondary icon-button icon-button--size-xs group-hoverable"
                                                aria-label="<?= $escaper->escapeHtmlAttr(__($filter->getName())) ?>"
                                            >
                                                <span style="rotate: -180deg;" x-ref="AccordionIcon">
                                                    <?= $hyvaicons->renderHtml('chevron-up'); ?>
                                                </span>
                                            </button>
                                        </div>
                                        <div
                                            x-ref="AccordionPanel"
                                            class="max-md:hidden overflow-hidden md:px-2"
                                            :class="{
                                                'transition-none': $store.main.isReducedMotion,
                                                'transition': $store.main.isReducedMotion
                                            }"
                                        >
                                            <?= $block->getChildBlock('renderer')->setFilterTitle($filter->getName())->render($filter); ?>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="$store.main.isMobile">
                                    <div class="contents">
                                        <!-- Mobile filters navigation -->
                                        <button
                                            @click="$store.popup.showPopup('<?= $filter['attribute_model']['attribute_code'] ?>')"
                                            type="button"
                                            class="button duration-300 button--outline-secondary md:hidden"
                                        >
                                            <?= $filter->getName() ?>
                                        </button>
                                        <?=
                                            $popup
                                                ->setData([
                                                    'id' => $filter['attribute_model']['attribute_code'],
                                                    'isFocused' => true,
                                                    'isFullScreen' => false,
                                                ])
                                                ->setChildHtml($block->getChildBlock('renderer')->setFilterTitle($filter->getName())->render($filter))
                                                ->render()
                                        ?>
                                    </div>
                                </template>
                            </fieldset>
                        <?php endforeach; ?>

                    </div>
                    <div x-intersect:full="isTopFilterVisible = true" x-intersect:leave="isTopFilterVisible = false" x-morph-ignore></div>
                </div>
            </div>
        </template>
    </div>
<?php endif; ?>
